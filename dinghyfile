{
  "application": "website-gitops",
  "spec": 
  {
    "email": "andrew.way@armory.io"
  },
  "globals": {
    "waitTime": "10"
  },
  "deleteStalePipelines": true,
  "pipelines": [
    {
      "application": "website-gitops",
      "name": "Deploy and Check [GitOps]",
      "expectedArtifacts": [],
      "keepWaitingPipelines": false,
      "lastModifiedBy": "anonymous",
      "limitConcurrent": true,
      "parameterConfig": [
        {
          "default": "1",
          "description": "How many dev instances would you like?",
          "label": "Number of Dev pods",
          "name": "devcount",
          "required": false
        },
        {
          "default": "10",
          "description": "How many prod instances would you like?",
          "label": "Number of Prod pods",
          "name": "prodcount"
        }
      ],
      "stages": [
        {
          "account": "dev-us-west-2",
          "cloudProvider": "kubernetes",
          "isNew": true,
          "manifests": [
            {
              "apiVersion": "v1",
              "kind": "Service",
              "metadata": {
                "name": "website-service",
                "namespace": "dev"
              },
              "spec": {
                "ports": [
                  {
                    "port": 80,
                    "protocol": "TCP",
                    "targetPort": 80
                  }
                ],
                "selector": {
                  "app": "website"
                },
                "type": "LoadBalancer"
              }
            }
          ],
          "moniker": {
            "app": "website-gitops"
          },
          "name": "Deploy LB",
          "refId": "Deploy LB Dev",
          "requisiteStageRefIds": [],
          "skipExpressionEvaluation": false,
          "source": "text",
          "trafficManagement": {
            "enabled": false,
            "options": {
              "enableTraffic": false,
              "namespace": null,
              "services": [],
              "strategy": null
            }
          },
          "type": "deployManifest"
        },
        {{
          module "deploy.stage.away.v1" 
          "account" "dev-us-west-2"
          "name" "Deploy to Test Apr-03-2020"
          "namespace" "dev"
          "refId" "deployDev"
        }},
        {
          "continuePipeline": false,
          "failPipeline": true,
          "job": "do-nothing",
          "master": "jenkins-sales",
          "name": "Automated Test (via Jenkins)",
          "parameters": {
            "customconfig": "run test",
            "special": false
          },
          "propertyFile": "build.properties",
          "refId": "IntegrationTest",
          "requisiteStageRefIds": [
            "deployDev"
          ],
          "type": "jenkins"
        },
        {
          "continuePipeline": false,
          "failPipeline": true,
          "job": "do-nothing",
          "master": "jenkins-sales",
          "name": "Security Scan",
          "parameters": {
            "customconfig": "perform a scan",
            "special": true
          },
          "propertyFile": "build.properties",
          "refId": "SecurityScan",
          "requisiteStageRefIds": [
            "deployDev"
          ],
          "type": "jenkins"
        },
        {{
          module "manual.judgement.module"
          "name" "Manual Judgment"
          "instructions" "Check the website. Did it deploy properly?"
          "requisiteStageRefIds" ["SecurityScan","IntegrationTest"]
          "judgmentInputs" [{"value": "But of course"}, {"value": "No"}]
        }},
        {
          "account": "prod-us-west-2",
          "cloudProvider": "kubernetes",
          "location": "prod",
          "manifestName": "deployment website-dev",
          "mode": "static",
          "name": "Undo Stage Rollout (Manifest)",
          "numRevisionsBack": 1,
          "refId": "3",
          "requisiteStageRefIds": [
            "Manual Judgment"
          ],
          "stageEnabled": {
            "expression": "${#judgment(\"Manual Judgment\") == \"No\"}",
            "type": "expression"
          },
          "type": "undoRolloutManifest"
        },
        {
          "account": "prod-us-west-2",
          "cloudProvider": "kubernetes",
          "isNew": true,
          "manifests": [
            {
              "apiVersion": "v1",
              "kind": "Service",
              "metadata": {
                "name": "website-service",
                "namespace": "prod"
              },
              "spec": {
                "ports": [
                  {
                    "port": 80,
                    "protocol": "TCP",
                    "targetPort": 80
                  }
                ],
                "selector": {
                  "app": "website"
                },
                "type": "LoadBalancer"
              }
            }
          ],
          "moniker": {
            "app": "website-gitops"
          },
          "name": "Deploy LB Prod",
          "refId": "Deploy LB Prod",
          "requisiteStageRefIds": ["Manual Judgment"],
          "skipExpressionEvaluation": false,
          "source": "text",
          "trafficManagement": {
            "enabled": false,
            "options": {
              "enableTraffic": false,
              "namespace": null,
              "services": [],
              "strategy": null
            }
          },
          "type": "deployManifest"
        },
        {{
          module "deploy.stage.away.v1" 
          "account" "prod-us-west-2"
          "name" "Deploy to Prod"
          "namespace" "prod"
          "refId" "deployProd"
          "requisiteStageRefIds" ["Manual Judgment", "Deploy LB Prod"]
          "stageEnabledExpression" "${#judgment('Manual Judgment') != 'No'}"
        }},
        {{
          module "wait.stage.module"
          "name" "Deploy to Private K8s"
          "waitTime" 15
          "requisiteStageRefIds" ["Manual Judgment"]
        }},
        {{
          module "wait.stage.module"
          "name" "Deploy to AKS Prod"
          "requisiteStageRefIds" ["Manual Judgment"]
        }},
        {{
          module "wait.stage.module"
          "name" "Deploy to EKS Prod"
          "requisiteStageRefIds" ["Manual Judgment"]
        }},
        {{
          module "wait.stage.module"
          "name" "Deploy to PKS K8s"
          "requisiteStageRefIds" ["Manual Judgment"]
        }},
        {{
          module "wait.stage.module"
          "name" "Deploy to OpenShift K8s"
          "requisiteStageRefIds" ["Manual Judgment"]
        }}
      ],
      "triggers": [
        {
          "account": "docker-registry-away168",
          "enabled": false,
          "organization": "away168",
          "registry": "index.docker.io",
          "repository": "away168/mysite",
          "tag": "",
          "type": "docker"
        }
      ],
      "updateTs": "1568781085000"
    }
  ]
}

{
  "application": "website",
  "deleteStalePipelines": false,
  "pipelines": [
    {
      "application": "website",
      "name": "Deploy and Check [Dinghy]",
      "expectedArtifacts": [],
      "keepWaitingPipelines": false,
      "lastModifiedBy": "anonymous",
      "limitConcurrent": true,
      "parameterConfig": [
        {
          "default": "10",
          "description": "How many dev instances would you like?",
          "label": "Number of Dev pods",
          "name": "devcount",
          "required": false
        },
        {
          "default": "10",
          "description": "How many prod instances would you like?",
          "label": "Number of Prod pods",
          "name": "prodcount"
        }
      ],
      "stages": [
        {{
          module "deploy.stage.module" 
          "account" "gke-away"
          "name" "Deploy to Dev"
          "namespace" "dev"
          "refId" "deployDev"
        }},
        {
          "continuePipeline": false,
          "failPipeline": true,
          "job": "IntegrationTest-Website",
          "master": "my-jenkins-master",
          "name": "Automated Test (via Jenkins)",
          "parameters": {
            "DemoBoolean": true,
            "DemoString": "Foo"
          },
          "propertyFile": "build.properties",
          "refId": "IntegrationTest",
          "requisiteStageRefIds": [
            "deployDev"
          ],
          "type": "jenkins"
        },
        {
          "continuePipeline": false,
          "failPipeline": true,
          "job": "SecurityScan",
          "master": "my-jenkins-master",
          "name": "Security Scan",
          "parameters": {
            "DependencyCheck": true,
            "Environment": "${trigger.user}"
          },
          "propertyFile": "scan.properties",
          "refId": "SecurityScan",
          "requisiteStageRefIds": [
            "deployDev"
          ],
          "type": "jenkins"
        },
        {
          "failPipeline": true,
          "instructions": "Go Check the website (ingress)\nDid it deploy properly?",
          "judgmentInputs": [
            {
              "value": "Roll-on to ${trigger.tag}"
            },
            {
              "value": "Nope"
            }
          ],
          "name": "Manual Judgment",
          "notifications": [
            {
              "address": "se-notifications",
              "level": "stage",
              "type": "slack",
              "when": [
                "manualJudgment",
                "manualJudgmentContinue",
                "manualJudgmentStop"
              ]
            }
          ],
          "refId": "2",
          "requisiteStageRefIds": [
            "SecurityScan",
            "IntegrationTest"
          ],
          "sendNotifications": true,
          "type": "manualJudgment"
        },
        {
          "account": "gke-away",
          "cloudProvider": "kubernetes",
          "location": "dev",
          "manifestName": "deployment website-dev",
          "mode": "static",
          "name": "Undo Stage Rollout (Manifest)",
          "numRevisionsBack": 1,
          "refId": "3",
          "requisiteStageRefIds": [
            "2"
          ],
          "stageEnabled": {
            "expression": "${#judgment(\"Manual Judgment\") == \"Nope\"}",
            "type": "expression"
          },
          "type": "undoRolloutManifest"
        },
        {{
          module "deploy.stage.module" 
          "account" "gke-away"
          "name" "Deploy to GKE Prod"
          "namespace" "prod"
          "refId" "deployProd"
          "requisiteStageRefIds" ["2"]
          "stageEnabledExpression" "${#judgment(\"Manual Judgment\") != \"Nope\"}"
        }},
        {
          "account": "gke-away",
          "cloudProvider": "kubernetes",
          "manifestArtifactAccount": "away168-github-artifact-account",
          "manifests": [
            {
              "apiVersion": "apps/v1",
              "kind": "Deployment",
              "metadata": {
                "labels": {
                  "app": "website"
                },
                "name": "website-prod",
                "namespace": "prod"
              },
              "spec": {
                "replicas": "${ #toInt( parameters.prodcount )  }",
                "selector": {
                  "matchLabels": {
                    "app": "website"
                  }
                },
                "template": {
                  "metadata": {
                    "labels": {
                      "app": "website"
                    }
                  },
                  "spec": {
                    "containers": [
                      {
                        "image": "away168/mysite:${trigger.tag}",
                        "name": "mysite",
                        "ports": [
                          {
                            "containerPort": 80
                          }
                        ]
                      }
                    ]
                  }
                }
              }
            }
          ],
          "moniker": {
            "app": "website"
          },
          "name": "Deploy to GKE Prod",
          "refId": "4",
          "relationships": {
            "loadBalancers": [],
            "securityGroups": []
          },
          "requisiteStageRefIds": [
            "2"
          ],
          "skipExpressionEvaluation": false,
          "source": "text",
          "stageEnabled": {
            "expression": "${#judgment(\"Manual Judgment\") != \"Nope\"}",
            "type": "expression"
          },
          "trafficManagement": {
            "enabled": false,
            "options": {
              "enableTraffic": true,
              "namespace": "prod",
              "services": [
                "service website-prod-service"
              ],
              "strategy": "redblack"
            }
          },
          "type": "deployManifest"
        },
        {
          "name": "Deploy to AKS Prod",
          "refId": "8",
          "requisiteStageRefIds": [
            "2"
          ],
          "type": "wait",
          "waitTime": 15
        },
        {
          "name": "Deploy to AWS Prod",
          "refId": "9",
          "requisiteStageRefIds": [
            "2"
          ],
          "type": "wait",
          "waitTime": 15
        },
        {
          "name": "Deploy to PKS Prod",
          "refId": "10",
          "requisiteStageRefIds": [
            "2"
          ],
          "type": "wait",
          "waitTime": 15
        },
        {
          "name": "Deploy to OpenShift Prod",
          "refId": "11",
          "requisiteStageRefIds": [
            "2"
          ],
          "type": "wait",
          "waitTime": 15
        }
      ],
      "triggers": [
        {
          "account": "docker-registry-away168",
          "enabled": false,
          "organization": "away168",
          "registry": "index.docker.io",
          "repository": "away168/mysite",
          "tag": "",
          "type": "docker"
        }
      ],
      "updateTs": "1568781085000"
    }
  ]
}
